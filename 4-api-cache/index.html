<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>4. Cache Strategy for REST API | PWA Workshop</title>
  <meta name="description" content="Introduction to Progressive Web Applications">
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PWA Workshop Docs">
  <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">

  <link rel="preload" href="https://womakerscode.github.io/pwa-workshop/css/0.styles.29df42ad.css" as="style">
  <link rel="preload" href="https://womakerscode.github.io/pwa-workshop/js/app.27d2dbf1.js" as="script">
  <link rel="preload" href="https://womakerscode.github.io/pwa-workshop/js/11.3ab35c1a.js" as="script">
  <link rel="preload" href="https://womakerscode.github.io/pwa-workshop/js/8.da3dd183.js" as="script">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/10.9725dfa9.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/12.1d8783c0.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/13.12e452ca.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/14.f551e499.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/15.d183389d.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/16.2bd9d4ec.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/17.e0c70547.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/18.1ac62902.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/19.c1d9eee1.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/2.23c6cee6.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/20.16db73fe.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/21.cd131399.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/3.f38c0f84.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/4.f0dfd132.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/5.7c9ddfb1.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/6.4db51655.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/7.67599f73.js">
  <link rel="prefetch" href="https://womakerscode.github.io/pwa-workshop/js/9.c634f727.js">
  <link rel="stylesheet" href="https://womakerscode.github.io/pwa-workshop/css/0.styles.29df42ad.css">
</head>

<body>
  <div id="app" data-server-rendered="true">
    <div class="theme-container">
      <header class="navbar">
        <div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img"
            viewBox="0 0 448 512" class="icon">
            <path fill="currentColor"
              d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z">
            </path>
          </svg></div> <a href="https://womakerscode.github.io/pwa-workshop/"
          class="home-link router-link-exact-active router-link-active">
          <!----> <span class="site-name">PWA Workshop</span></a>

      </header>
      <div class="sidebar-mask"></div>
      <div class="sidebar">

        <ul class="sidebar-links">
          <li><a href="https://womakerscode.github.io/pwa-workshop/" class="active sidebar-link">Introdução</a>
            <ul class="sidebar-sub-headers">
              <li class="sidebar-sub-header"><a href="https://womakerscode.github.io/pwa-workshop/#requirements"
                  class="sidebar-link">Requisitos</a></li>
              <li class="sidebar-sub-header"><a href="https://womakerscode.github.io/pwa-workshop/#preparation"
                  class="sidebar-link">Preparação</a></li>
              <li class="sidebar-sub-header"><a
                  href="https://womakerscode.github.io/pwa-workshop/#steps-of-the-workshop" class="sidebar-link">Tutorial do Workshop</a></li>
            </ul>
          </li>
          <li><a href="https://womakerscode.github.io/pwa-workshop/1-manifest/" class="sidebar-link">1. Adicionando
            o Manifesto</a></li>
          <li><a href="https://womakerscode.github.io/pwa-workshop/2-service-worker/" class="sidebar-link">2. Instalando o
              Service Worker</a></li>
          <li><a href="https://womakerscode.github.io/pwa-workshop/3-precaching/" class="sidebar-link">3. Precaching e modo offline básico
              </a></li>
          <li><a href="https://womakerscode.github.io/pwa-workshop/4-api-cache/" class="sidebar-link">4. Estratégia de Cache para REST API</a></li>
          <li><a href="https://womakerscode.github.io/pwa-workshop/5-background-sync/" class="sidebar-link">5.
              Background sync e notificações</a></li>
          <li><a href="https://womakerscode.github.io/pwa-workshop/6-pwa-setup/" class="sidebar-link">6. Exibindo o botão de instalação</a></li>
          <li><a href="https://womakerscode.github.io/pwa-workshop/finish.html" class="sidebar-link">Ir adiante</a>
          </li>
        </ul>
      </div>
      <div class="page">
        <div class="content">
          <h1 id="step-4-cache-update-refresh-strategy-for-get-requests-from-the-rest-api"><a
              href="#step-4-cache-update-refresh-strategy-for-get-requests-from-the-rest-api" aria-hidden="true"
              class="header-anchor">#</a> Step 4: Cache / Update / Refresh strategy for GET requests from the REST API
          </h1>
          <p>We saw in the previous step how to cache static files. The strategy we have put in place for these files is
            called <em>Cache-First</em>, that is, always return the cached version if available. What about dynamic
            data, typically API responses?</p>
          <p>To have an offline mode, we also need to put this data in a local cache. On the other hand, unlike static
            files, it is important for the user to have the most recent data (the &quot;freshest&quot;) as soon as
            possible. So we have to change our strategy.</p>
          <h2 id="cache-update-refresh"><a href="#cache-update-refresh" aria-hidden="true" class="header-anchor">#</a>
            Cache, Update, Refresh</h2>
          <p>This cache strategy is slightly more complex but allows the use of the local cache to significantly speed
            up the first loading time, even if temporarily displaying data that is out of date.</p>
          <p>For each request, the Worker service will first immediately return a cached response if it exists, and then
            in parallel query the network. Upon receiving the response from the network, the cached entry will be
            updated and the user interface will be updated automatically.</p>
          <p>Refreshing the interface can be done in different ways depending on your use case. You can simply add items
            dynamically to a list, like messages in an instant conversation for example. Or notify the user in another
            way, for example with a link proposing to load the new content available.</p>
          <p><img src="https://womakerscode.github.io/pwa-workshop/img/schema.688fdb36.png" alt="Flowsheet"></p>
          <p>Advantages:</p>
          <ul>
            <li>Instant load if a response is cached</li>
            <li>Can improve the user experience</li>
          </ul>
          <p>Disadvantages:</p>
          <ul>
            <li>The user must not be able to interact with out-to-date data</li>
            <li>Refreshing the interface after network response can disturb the user if UX is not well thought out</li>
          </ul>
          <h2 id="implementation"><a href="#implementation" aria-hidden="true" class="header-anchor">#</a>
            Implementation</h2>
          <p>For our application, we will implement this <em>Cache, Update, Refresh</em> strategy to load the list of
            workshop attendees. This list will probably change a little between each request and most of the successive
            changes will be the addition of a few attendees. Refreshing the view should therefore be quite natural for
            the user. This strategy seems to be the most appropriate in this case.</p>
          <h3 id="choosing-the-right-strategy-depending-on-the-request"><a
              href="#choosing-the-right-strategy-depending-on-the-request" aria-hidden="true"
              class="header-anchor">#</a> Choosing the right strategy depending on the request</h3>
          <p>Let's start again with the Service Worker code in the <code>fetch</code> event callback. We will
            distinguish requests to our API from requests to static files, in order to apply a different strategy:</p>
          <div class="language-js extra-class">
            <pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;/api/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token comment">// response to API requests, Cache Update Refresh strategy</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// response to static files requests, Cache-First strategy</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
          </div>
          <p>All our requests to the API go through the same endpoint containing <code>/api/</code> in the URL. So, we
            can easily identify these requests based on the URL accessible from <code>event.request.url</code>. Here is
            the <a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent" target="_blank"
              rel="noopener noreferrer">FetchEvent API documentation<svg xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound">
                <path fill="currentColor"
                  d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z">
                </path>
                <polygon fill="currentColor"
                  points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9">
                </polygon>
              </svg></a>.</p>
          <h3 id="_1-cache"><a href="#_1-cache" aria-hidden="true" class="header-anchor">#</a> 1. Cache</h3>
          <p>The first step is to respond immediately with the cached response if it exists. You can do this by reusing
            the <code>caches.match</code> function seen in step 3 to respons to static files requests.</p>
          <details class="hidden" data-v-1bf9d1e0>
            <summary data-v-1bf9d1e0>See the solution</summary>
            <div class="language-js extra-class" data-v-1bf9d1e0>
              <pre class="language-js" data-v-1bf9d1e0><code data-v-1bf9d1e0><span class="token keyword" data-v-1bf9d1e0>if</span> <span class="token punctuation" data-v-1bf9d1e0>(</span>event<span class="token punctuation" data-v-1bf9d1e0>.</span>request<span class="token punctuation" data-v-1bf9d1e0>.</span>url<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>includes</span><span class="token punctuation" data-v-1bf9d1e0>(</span><span class="token string" data-v-1bf9d1e0>&quot;/api/&quot;</span><span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>)</span> <span class="token punctuation" data-v-1bf9d1e0>{</span>
    <span class="token comment" data-v-1bf9d1e0>// response to API requests, Cache Update Refresh strategy</span>
    event<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>respondWith</span><span class="token punctuation" data-v-1bf9d1e0>(</span>caches<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>match</span><span class="token punctuation" data-v-1bf9d1e0>(</span>event<span class="token punctuation" data-v-1bf9d1e0>.</span>request<span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>)</span>
    <span class="token comment" data-v-1bf9d1e0>//TODO: update et refresh</span>
<span class="token punctuation" data-v-1bf9d1e0>}</span>
</code></pre>
            </div>
          </details>
          <h3 id="_2-update"><a href="#_2-update" aria-hidden="true" class="header-anchor">#</a> 2. Update</h3>
          <p>In parallel, the request to the network also has be made with the <code>fetch(request)</code> method, then
            we update the cache with the response via the <code>cache.put</code> method. Declare the <code>update</code>
            function below in the Service Worker code:</p>
          <div class="language-js extra-class">
            <pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Network error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

		<span class="token comment">// we can put response in cache</span>
		<span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cache</span> <span class="token operator">=&gt;</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">)</span> <span class="token comment">// resolve promise with the Response object</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
          </div>
          <div class="warning custom-block">
            <p class="custom-block-title">Warning</p>
            <p>An answer can only be read once, so it must be cloned with the <code>.clone()</code> method before
              caching it.</p>
          </div>
          <p>Then, call this <code>update</code> function in the<code>fetch</code> callback in parallel with the
            response with the cached version. You can still continue to use the <code>event</code> object in the
            following code even after a first <code>event.respondWith</code>. However, you will need to use the
            <code>event.waitUntil()</code> method to extend the life of the event and tell the browser that more work
            needs to be done beyond the initial response.</p>
          <details class="hidden" data-v-1bf9d1e0>
            <summary data-v-1bf9d1e0>See the solution</summary>
            <div class="language-js extra-class" data-v-1bf9d1e0>
              <pre class="language-js" data-v-1bf9d1e0><code data-v-1bf9d1e0><span class="token keyword" data-v-1bf9d1e0>if</span> <span class="token punctuation" data-v-1bf9d1e0>(</span>event<span class="token punctuation" data-v-1bf9d1e0>.</span>request<span class="token punctuation" data-v-1bf9d1e0>.</span>url<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>includes</span><span class="token punctuation" data-v-1bf9d1e0>(</span><span class="token string" data-v-1bf9d1e0>&quot;/api/&quot;</span><span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>)</span> <span class="token punctuation" data-v-1bf9d1e0>{</span>
    <span class="token comment" data-v-1bf9d1e0>// response to API requests, Cache Update Refresh strategy</span>
    event<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>respondWith</span><span class="token punctuation" data-v-1bf9d1e0>(</span>caches<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>match</span><span class="token punctuation" data-v-1bf9d1e0>(</span>event<span class="token punctuation" data-v-1bf9d1e0>.</span>request<span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>)</span>
    event<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>waitUntil</span><span class="token punctuation" data-v-1bf9d1e0>(</span><span class="token function" data-v-1bf9d1e0>update</span><span class="token punctuation" data-v-1bf9d1e0>(</span>event<span class="token punctuation" data-v-1bf9d1e0>.</span>request<span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>)</span> <span class="token comment" data-v-1bf9d1e0>//TODO: refresh</span>
<span class="token punctuation" data-v-1bf9d1e0>}</span>
</code></pre>
            </div>
          </details>
          <h3 id="_3-refresh"><a href="#_3-refresh" aria-hidden="true" class="header-anchor">#</a> 3. Refresh</h3>
          <p>If the network has responded and the response has been cached, you want to tell the application that new
            data is available to refresh the application view.</p>
          <p>Applications with a registered and installed Service Worker are referred to as &quot;clients&quot; for this
            Service Worker, and can be accessed through the <a
              href="https://developer.mozilla.org/en-US/docs/web/API/Clients" target="_blank"
              rel="noopener noreferrer">Clients API documented here<svg xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound">
                <path fill="currentColor"
                  d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z">
                </path>
                <polygon fill="currentColor"
                  points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9">
                </polygon>
              </svg></a>. The Service Worker communicates with the client through the <code>client.postMessage</code>
            method. The exchange format is textual, so you will need to serialize your data into JSON. The transmitted
            message will be an object composed with at least one property to identify the type of message (here we chose
            the URL of the corresponding request) and another property containing the data to be transmitted (the
            content of the response).</p>
          <p>Declare the <code>refresh</code> function below in the Service Worker code.</p>
          <div class="language-js extra-class">
            <pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// read and parse JSON response</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">jsonResponse</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">clients</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">client</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token comment">// report and send new data to client</span>
				client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    type<span class="token punctuation">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
                    data<span class="token punctuation">:</span> jsonResponse<span class="token punctuation">.</span>data
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> jsonResponse<span class="token punctuation">.</span>data<span class="token punctuation">;</span> <span class="token comment">// resolve promise with new data</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
          </div>
          <p>All that remains is to assemble the 3 <code>cache</code>, <code>update</code> and <code>refresh</code>
            blocks to finalize the strategy: the cache response with <code>event.respondWith</code>, then in parallel
            the update followed by the refresh in a <code>event.waitUntil</code>. The <code>update</code> function
            returns a<code>Promise</code> resolved with the network response, so you can chain it with
            <code>.then()</code> to execute another function after the network response.</p>
          <details class="hidden" data-v-1bf9d1e0>
            <summary data-v-1bf9d1e0>See the solution</summary>
            <div class="language-js extra-class" data-v-1bf9d1e0>
              <pre class="language-js" data-v-1bf9d1e0><code data-v-1bf9d1e0><span class="token keyword" data-v-1bf9d1e0>if</span><span class="token punctuation" data-v-1bf9d1e0>(</span>event<span class="token punctuation" data-v-1bf9d1e0>.</span>request<span class="token punctuation" data-v-1bf9d1e0>.</span>url<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>includes</span><span class="token punctuation" data-v-1bf9d1e0>(</span><span class="token string" data-v-1bf9d1e0>&quot;/api/&quot;</span><span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>{</span>
    <span class="token comment" data-v-1bf9d1e0>// response to API requests, Cache Update Refresh strategy</span>
    event<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>respondWith</span><span class="token punctuation" data-v-1bf9d1e0>(</span>caches<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>match</span><span class="token punctuation" data-v-1bf9d1e0>(</span>event<span class="token punctuation" data-v-1bf9d1e0>.</span>request<span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>)</span>
    event<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>waitUntil</span><span class="token punctuation" data-v-1bf9d1e0>(</span><span class="token function" data-v-1bf9d1e0>update</span><span class="token punctuation" data-v-1bf9d1e0>(</span>event<span class="token punctuation" data-v-1bf9d1e0>.</span>request<span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>then</span><span class="token punctuation" data-v-1bf9d1e0>(</span>refresh<span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>)</span>
<span class="token punctuation" data-v-1bf9d1e0>}</span>
</code></pre>
            </div>
          </details>
          <h2 id="refreshing-the-view"><a href="#refreshing-the-view" aria-hidden="true" class="header-anchor">#</a>
            Refreshing the view</h2>
          <p>The client can listen to messages emitted by the Service Worker via the
            <code>navigator.serviceWorker.onmessage</code> callback. Then you can deserialize the message with
            <code>JSON.parse(event.data)</code>. In <code>scripts.js</code>, once the Service Worker is registered,
            declare the following callback:</p>
          <div class="language-js extra-class">
            <pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//TODO: detect the type of message and refresh the view</span>
<span class="token punctuation">}</span>
</code></pre>
          </div>
          <p>The <code>renderAttendees</code> function allows you to update the list of attendees. The view will be
            updated when the Service Worker sends the message with the new data. Complete the code above, checking if
            the message is an update of the attendees list, then recall the <code>renderAttendees</code> function with
            the data received in the message.</p>
          <details class="hidden" data-v-1bf9d1e0>
            <summary data-v-1bf9d1e0>See the solution</summary>
            <div class="language-js extra-class" data-v-1bf9d1e0>
              <pre class="language-js" data-v-1bf9d1e0><code data-v-1bf9d1e0>navigator<span class="token punctuation" data-v-1bf9d1e0>.</span>serviceWorker<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function-variable function" data-v-1bf9d1e0>onmessage</span> <span class="token operator" data-v-1bf9d1e0>=</span> <span class="token parameter" data-v-1bf9d1e0>event</span> <span class="token operator" data-v-1bf9d1e0>=&gt;</span> <span class="token punctuation" data-v-1bf9d1e0>{</span>
	<span class="token keyword" data-v-1bf9d1e0>const</span> message <span class="token operator" data-v-1bf9d1e0>=</span> <span class="token constant" data-v-1bf9d1e0>JSON</span><span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>parse</span><span class="token punctuation" data-v-1bf9d1e0>(</span>event<span class="token punctuation" data-v-1bf9d1e0>.</span>data<span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>;</span>
	<span class="token keyword" data-v-1bf9d1e0>if</span><span class="token punctuation" data-v-1bf9d1e0>(</span>message <span class="token operator" data-v-1bf9d1e0>&amp;&amp;</span> message<span class="token punctuation" data-v-1bf9d1e0>.</span>type<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>includes</span><span class="token punctuation" data-v-1bf9d1e0>(</span><span class="token string" data-v-1bf9d1e0>&quot;/api/users&quot;</span><span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>)</span><span class="token punctuation" data-v-1bf9d1e0>{</span>
		console<span class="token punctuation" data-v-1bf9d1e0>.</span><span class="token function" data-v-1bf9d1e0>log</span><span class="token punctuation" data-v-1bf9d1e0>(</span><span class="token string" data-v-1bf9d1e0>&quot;List of attendees to date&quot;</span><span class="token punctuation" data-v-1bf9d1e0>,</span> message<span class="token punctuation" data-v-1bf9d1e0>.</span>data<span class="token punctuation" data-v-1bf9d1e0>)</span>
		<span class="token function" data-v-1bf9d1e0>renderAttendees</span><span class="token punctuation" data-v-1bf9d1e0>(</span>message<span class="token punctuation" data-v-1bf9d1e0>.</span>data<span class="token punctuation" data-v-1bf9d1e0>)</span>
	<span class="token punctuation" data-v-1bf9d1e0>}</span>
<span class="token punctuation" data-v-1bf9d1e0>}</span>
</code></pre>
            </div>
          </details>
          <h2 id="testing"><a href="#testing" aria-hidden="true" class="header-anchor">#</a> Testing</h2>
          <p>To test if the loading strategy works properly, since the application currently uses a mockup API with
            false data, we will simulate changes in the number of attendees and add a false network latency to give us
            the time to observe the strategy in action.</p>
          <p>Change the <code>update</code> function in<code>sw.js</code> like this:</p>
          <div class="language-js extra-class">
            <pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// mockup: load randomly between 1 and 10 attendees</span>
	<span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token template-string"><span class="token string">`?per_page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// add a fake latency of 3 seconds</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre>
          </div>
          <p>Make sure the Service Worker is up-to-date and reinstalled (in the Developer Tools, Application&gt; Service
            Workers tab, check the <em>Update on reload</em> check box, see step 2), then reload the page. You should
            see the old number of attendees, then 3 seconds later the list will refresh with a new number of attendees.
          </p>
        </div>
        <div class="page-edit">
          <!---->
          <!---->
        </div>
        <div class="page-nav">
          <p class="inner"><span class="prev">
              ←
              <a href="/3-precaching/" class="prev">
                3. Precaching and basic offline mode
              </a></span> <span class="next"><a href="/5-background-sync/">
                5. Background sync and notifications
              </a>
              →
            </span></p>
        </div>
      </div>
      <!---->
    </div>
  </div>
  <script src="https://womakerscode.github.io/pwa-workshop/js/app.27d2dbf1.js" defer></script>
  <script src="https://womakerscode.github.io/pwa-workshop/js/11.3ab35c1a.js" defer></script>
  <script src="https://womakerscode.github.io/pwa-workshop/js/8.da3dd183.js" defer></script>
</body>

</html>